# Подготовка к работе

1. Штатным образом выполните подключение к FortiGate и извлеките файл конфигурации в формате `*.conf`.
2. Скачайте и установите последнюю версию интерпретатора Python.
3. Выполните распаковку скрипта `convert_forti_to_c4.py`, разместив содержимое в любой каталог на рабочем месте (РМ) администратора.

>**Внимание:** Запуск скрипта `convert_forti_to_c4.py` может выполняться как на рабочем месте администратора с установленным менеджером конфигурации (МК), так и на стороннем рабочем месте. Если скрипт `convert_forti_to_c4.py` и МК находятся на разных РМ подразумевается, то сгенерированные файлы для импорта в МК необходимо будет перенести на РМ с установленным МК.

# Алгоритм работы

1. Запустите командную строку.
2. В командной строке перейдите в каталог, где распакован скрипт `convert_forti_to_c4.py`.
3. Запустите скрипт с помощью команды `python convert_forti_to_c4.py`.
4. На экран будет выведено руководство по использованию скрипта. Ознакомьтесь с руководством!
5. Следуя инструкции, укажите путь до файла c конфигурацией `*.сonf` (INPUT).
6. Следуя инструкции, укажите путь до папки для сохранения преобразованного файла (OUTPUT_PATH).
7. При необходимости Вы можете сохранить копию лога работы со скриптом преобразования правил (LOG_FILE).
8. При необходимости Вы можете скорректировать стандартное имя для преобразованного файла (NAME).
9. После ввода параметров согласно пунктам 5 - 11 подтвердите запуск процедуры преобразования с помощью клавиши клавиатуры "Enter".
10. Убедитесь, что по окончанию работы скрипта сгенерирован отчет о преобразовании объектов разных типов, включая правила, в командной строке.
11. Убедитесь, что по окончанию работы скрипта в папке для сохранения преобразованного файла лежит два файла:
    - файл, содержащий конфигурацию в универсальном формате `*.json`; 
    - отчет о результате операции импорта.

>**Примечание:** Если путь в параметрах не указан, файл с копией лога будет сохранен в директории, в которой скрипт был запущен. 

# Алгоритм импорта правил из различных систем в КБ "Континент. Версия 4" (далее – К4) через МК

1. Запустите МК.
2. Выполните подключение к ЦУС.
3. Перейдите в раздел "Контроль доступа – Межсетевой экран".
4. В пустой области секции "Межсетевой экран" используйте пункт "Импортировать" контекстного меню.
5. Будет выведено диалоговое окно для выбора файла конфигурации из внешней системы.
6. Выберите файл конфигурации в универсальном формате `*.json`, сгенерированный ранее скриптом `convert_forti_to_c4.py`.
7. Нажмите кнопку "Открыть".
8. Дождитесь окончания импорта.
9. После завершения операции импорта будет выведено информационное сообщение о результате выполнения импорта.
10. Ознакомьтесь с результатами выполнения импорта.
11. Перейдите в раздел "Контроль доступа – Трансляция сетевых адресов".
12. В пустой области секции "Трансляция сетевых адресов" используйте пункт "Импортировать" контекстного меню.
13. Будет выведено диалоговое окно для выбора файла конфигурации из внешней системы.
14. Выберите файл конфигурации в универсальном формате `*.json`, сгенерированный ранее скриптом `convert_forti_to_c4.py`.
15. Нажмите кнопку "Открыть".
16. Дождитесь окончания импорта.
17. После завершения операции импорта будет выведено информационное сообщение о результате выполнения импорта.
18. Ознакомьтесь с результатами выполнения импорта.

## Просмотр детальной информации о результатах импорта

1. Перейдите в раздел "Администрирование – Задачи".
2. Выберите в списке задачу "Импорт политики контроля доступа", соответствующую времени запуска и окончания импорта.
3. В окне "Информация" будет представлен отчет, содержащем сообщения о результатах операции импорта. Если окно не отображается, перейдите на вкладку "Вид" и активируйте кнопку "Информация". 

## Замечания для правил фильтрации

1. Все импортированные правила на стороне К4 будут отключены.
2. Если в качестве `srcaddr` на стороне FortiGate не указано ни одного сетевого объекта, на стороне К4 для "Отправителя" будет установлено значение "Любой" / "Any".
3. Если в качестве `dstaddr` на стороне FortiGate не указано ни одного сетевого объекта, на стороне К4 для "Получателя" будет установлено значение "Любой" / "Any".
4. Если в качестве `service` на стороне FortiGate не указано ни одного объекта, на стороне К4 для "Сервиса" будет установлено значение "Любой" / "Any".
5. Если в качестве `schedule` на стороне FortiGate не указано ни одного объекта, на стороне К4 для "Временного интервала" будет установлено значение "Всегда" / "Always".
6. При импорте правил из FortiGate в К4 параметр "Действие" / "Action" переносится согласно следующим правилам:
    - если в качестве `action` на стороне FortiGate указано значение `accept`, на стороне К4 для "Действия" будет установлено значение "Пропустить" / "Accept";
    - в остальных случаях на стороне К4 для "Действия" будет установлено значение "Отбросить" / "Block".
7. В К4 не переносятся параметры: `srcintf`, `dstintf`, `ssl-ssh-profile`, `utm-status`, `av-profile`, `webfilter-profile`, `dnsfilter-profile`, `file-filter-profile`, `ips-sensor`, `application-list`, `wccp`, `captive-portal-exempt`, `inspection-mode`.
8. При импорте правил из FortiGate в К4 будут добавлены следующие необходимые для корректной работы системы параметры (для этих параметров на стороне К4 будут установлены значения по умолчанию):
    - Профиль Web/FTP фильтрации;
    - Приложение;
    - СОВ.
9. При импорте правил из FortiGate в К4 не осуществляется перенос сетевых объектов, тип которых отличается от `iprange`, `subnet`, `vip`, `vipgrp`, `interface-subnet`.
10. При импорте правил из FortiGate в К4 не осуществляется перенос временных объектов из раздела `firewall schedule group`.
11. При импорте правил из FortiGate в К4 не осуществляется перенос сервисов с протоколами `0` / `41` / `43` / `44` / `45` / `46` / `50` / `51` / `58` / `59` / `60`.
12. При импорте правил из FortiGate в К4 не осуществляется перенос сервисов, протокол которых отличается от `icmp`, `ip`, `tcp`, `udp`.
13. Для сетевых объектов типа `interface-subnet` при импорте правил из FortiGate в К4 не осуществляется перенос параметра `interface`.
14. Для сетевых объектов типа `subnet` при импорте правил из FortiGate в К4 не осуществляется перенос параметров: `allow-routing`, `associated-interface`.
15. Для сервисов типа `icmp` при импорте правил из FortiGate в К4 не осуществляется перенос параметра `visibility`.
16. Не осуществляется перенос сервисов типа `icmp`, если их тип и код не входят в перечень поддерживаемых.

## Замечания для правил фильтрации

1. Все импортированные правила на стороне К4 будут отключены.
2. Если в качестве `srcaddr` на стороне FortiGate не указано ни одного сетевого объекта, на стороне К4 для "Отправителя" будет установлено значение "Любой" / "Any".
3. Если в качестве `dstaddr` на стороне FortiGate не указан `vip` объект, на стороне К4 для "Получателя", "Сервиса" и аналогичных значений транслированного пакета будет установлено значение "Любой" / "Any".
4. Если в качестве `dstaddr` на стороне FortiGate не указано ни одного сетевого объекта, на стороне К4 для "Получателя" будет установлено значение "Любой" / "Any".
5. Если в оригинальном правиле на стороне FortiGate установлено значение `disable` для поля `nat` и не используются объекты `vip`, то такое правило трансляции не переносится.
6. Не осуществляется перенос правил, для которых на стороне FortiGate поля сервиса или транслированного сервиса содержат протокол, который отличается от `6` (TCP) или `17` (UDP).
7. При импорте правил из FortiGate в К4 не осуществляется перенос сетевых объектов, тип которых отличается от `iprange`, `subnet`, `vip`, `vipgrp`, `interface-subnet`.
8. Для сетевых объектов типа `interface-subnet` при импорте правил из FortiGate в К4 не осуществляется перенос параметра `interface`.
9. Для сетевых объектов типа `subnet` при импорте правил из FortiGate в К4 не осуществляется перенос параметров: `allow-routing`, `associated-interface`.
10. При импорте правил из FortiGate в К4 тип трансляции переносится согласно следующим правилам:
    - если на стороне FortiGate используется `vip` объект в поле `dstaddr`, то будет установлено значение "Получателя" / "Destination";
    - если на стороне FortiGate используется `ippool` объект и поле `type` имеет значение 'one-to-one', то будет установлено значение "Отобразить" / "One-to-one";
    - если на стороне FortiGate используется `ippool` объект и в поле `type` не установлено значение, то будет установлено значение "Отправителя" / "Source";
    - в остальных случаях будет установлено значение "Скрыть" / "Hide".

## Список поддерживаемых типов/кодов сообщений ICMP

С полным перечнем типов/кодов, включая их описание, можно ознакомиться по [ссылке](https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml)

| Номер типа | Номер кода |
|------------|------------|
| -          | -          |
| 0          | 0          |
| 3          | 0          |
| 3          | 1          |
| 3          | 2          |
| 3          | 3          |
| 3          | 4          |
| 3          | 5          |
| 3          | 6          |
| 3          | 7          |
| 3          | 8          |
| 3          | 9          |
| 3          | 10         |
| 3          | 11         |
| 3          | 12         |
| 3          | 13         |
| 3          | 14         |
| 3          | 15         |
| 4          | 0          |
| 5          | 0          |
| 5          | 1          |
| 5          | 2          |
| 5          | 3          |
| 6          | 0          |
| 8          | 0          |
| 9          | 0          |
| 9          | 16         |
| 10         | 0          |
| 11         | 0          |
| 11         | 1          |
| 12         | 0          |
| 12         | 1          |
| 12         | 2          |
| 13         | 0          |
| 14         | 0          |
| 15         | 0          |
| 16         | 0          |
| 17         | 0          |
| 18         | 0          |
| 30         | -          |
| 31         | -          |
| 32         | -          |
| 33         | -          |
| 34         | -          |
| 35         | -          |
| 36         | -          |
| 37         | -          |
| 38         | -          |
| 39         | -          |
| 40         | 0          |
| 40         | 1          |
| 40         | 2          |
| 40         | 3          |
| 40         | 4          |
| 40         | 5          |
| 41         | -          |
| 42         | 0          |
| 43         | 0          |
| 43         | 1          |
| 43         | 2          |
| 43         | 3          |
| 43         | 4          |

# Приложения

К инструменту прилагаются следующие материалы:

- `c4_unified_json.svg` - описание структуры (схема) импортируемых данных.
